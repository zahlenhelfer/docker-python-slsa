name: Verify SLSA Provenance

on:
    workflow_dispatch:
        inputs:
            image-tag:
                description: "Image tag to verify"
                required: true
                default: "main"

permissions:
    contents: read
    packages: read

env:
    REGISTRY: ghcr.io
    IMAGE_NAME: ${{ github.repository }}

jobs:
    verify:
        runs-on: ubuntu-latest

        steps:
            - name: Log in to Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Pull image and get digest
              id: image-info
              run: |
                  IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.event.inputs.image-tag }}"
                  docker pull "$IMAGE"
                  DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' "$IMAGE" | cut -d'@' -f2)
                  echo "digest=$DIGEST" >> $GITHUB_OUTPUT
                  echo "full-image=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@$DIGEST" >> $GITHUB_OUTPUT

            - name: Install slsa-verifier
              run: |
                  curl -sSLo slsa-verifier https://github.com/slsa-framework/slsa-verifier/releases/download/v2.5.1/slsa-verifier-linux-amd64
                  chmod +x slsa-verifier
                  sudo mv slsa-verifier /usr/local/bin/

            - name: Verify SLSA provenance
              env:
                  IMAGE: ${{ steps.image-info.outputs.full-image }}
              run: |
                  slsa-verifier verify-image "$IMAGE" \
                    --source-uri github.com/${{ github.repository }} \
                    --source-tag ${{ github.event.inputs.image-tag }}

            - name: Download and inspect provenance
              env:
                  IMAGE: ${{ steps.image-info.outputs.full-image }}
              run: |
                  echo "Downloading provenance attestation..."
                  slsa-verifier verify-image "$IMAGE" \
                    --source-uri github.com/${{ github.repository }} \
                    --print-provenance | tee provenance.json

                  echo ""
                  echo "=== Provenance Summary ==="
                  jq -r '.predicate.buildType' provenance.json
                  jq -r '.predicate.builder.id' provenance.json

            - name: Upload provenance artifact
              uses: actions/upload-artifact@v4
              with:
                  name: provenance-attestation
                  path: provenance.json

    security-scan:
        runs-on: ubuntu-latest
        needs: verify

        steps:
            - name: Log in to Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Run Trivy vulnerability scanner
              uses: aquasecurity/trivy-action@master
              with:
                  image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.event.inputs.image-tag }}
                  format: "sarif"
                  output: "trivy-results.sarif"

            - name: Upload Trivy results
              uses: github/codeql-action/upload-sarif@v3
              if: always()
              with:
                  sarif_file: "trivy-results.sarif"
