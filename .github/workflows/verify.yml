name: Verify SLSA Provenance

on:
    workflow_dispatch:
        inputs:
            image-tag:
                description: "Image tag to verify (e.g., v1.0.0)"
                required: true
                type: string

permissions:
    contents: read
    packages: read

env:
    REGISTRY: ghcr.io
    IMAGE_NAME: ${{ github.repository }}

jobs:
    verify:
        runs-on: ubuntu-latest
        steps:
            - name: Validate tag format
              run: |
                  TAG="${{ github.event.inputs.image-tag }}"
                  if [[ ! "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
                    echo "❌ Error: Tag must be in format v*.*.* (e.g., v1.0.0)"
                    exit 1
                  fi
                  echo "✅ Tag format is valid: $TAG"

            - name: Log in to Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Pull image and get digest
              id: image-info
              run: |
                  TAG="${{ github.event.inputs.image-tag }}"
                  IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${TAG}"

                  echo "Pulling image: $IMAGE"
                  docker pull "$IMAGE"

                  DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' "$IMAGE" | cut -d'@' -f2)
                  FULL_IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${DIGEST}"

                  echo "digest=$DIGEST" >> $GITHUB_OUTPUT
                  echo "full-image=$FULL_IMAGE" >> $GITHUB_OUTPUT

                  echo "Image: $FULL_IMAGE"

            - name: Install slsa-verifier
              run: |
                  curl -sSLo slsa-verifier https://github.com/slsa-framework/slsa-verifier/releases/download/v2.5.1/slsa-verifier-linux-amd64
                  chmod +x slsa-verifier
                  sudo mv slsa-verifier /usr/local/bin/

            - name: Verify SLSA provenance
              env:
                  IMAGE: ${{ steps.image-info.outputs.full-image }}
                  TAG: ${{ github.event.inputs.image-tag }}
              run: |
                  echo "=== Verifying SLSA Provenance ==="
                  echo "Image: $IMAGE"
                  echo "Source Tag: $TAG"
                  echo ""

                  slsa-verifier verify-image "$IMAGE" \
                    --source-uri github.com/${{ github.repository }} \
                    --source-tag "$TAG"

                  echo ""
                  echo "✅ SLSA verification successful!"

            - name: Display provenance
              env:
                  IMAGE: ${{ steps.image-info.outputs.full-image }}
              run: |
                  echo "=== SLSA Provenance Details ==="
                  slsa-verifier verify-image "$IMAGE" \
                    --source-uri github.com/${{ github.repository }} \
                    --source-tag "${{ github.event.inputs.image-tag }}" \
                    --print-provenance | jq '.'

            - name: Generate verification report
              if: always()
              run: |
                  cat << EOF > verification-report.md
                  # SLSA Verification Report

                  **Status:** ${{ job.status }}
                  **Image:** \`${{ steps.image-info.outputs.full-image }}\`
                  **Tag:** \`${{ github.event.inputs.image-tag }}\`
                  **Repository:** \`${{ github.repository }}\`
                  **Verified at:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")

                  ## Verification Command
                  \`\`\`bash
                  slsa-verifier verify-image \\
                    ${{ steps.image-info.outputs.full-image }} \\
                    --source-uri github.com/${{ github.repository }} \\
                    --source-tag ${{ github.event.inputs.image-tag }}
                  \`\`\`
                  EOF

                  cat verification-report.md >> $GITHUB_STEP_SUMMARY

            - name: Upload verification report
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: verification-report
                  path: verification-report.md
